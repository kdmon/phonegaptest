<html>

  <head>
    <style>
      button, input, .answer {
        font-size: 2em;
        padding: 10px;
      }
    </style>
    <script type="text/javascript" src="phonegap.js"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://it4se.com:9000/socket.io/socket.io.js"></script>
    <script>
    
        var alias = '';
        var dready = false;
        var c = 100;
        
        
        var socket = io.connect('http://it4se.com:9000');
        
        socket.on('serverUpdate', function (data) {
          
          switch (data.server.action) {
            
            case "answered":
              if (dready)  {
                navigator.app.loadUrl("http://it4se.com:8080/kdmon/phonegaptest/master/webrtc.html?room=" + data.server.message.room, {openExternal : true});
              }
              else {
                window.open ("http://it4se.com:8080/kdmon/phonegaptest/master/webrtc.html?room=" + data.server.message.room);
              }
            break;
            
            case "invitation":
            
              $("#messages").html('');
              $("#messages").append("<h2>Video call from " + data.server.message.caller + '</h2>');
              
              // mobile device
              if (dready)  {
                // background notification
                msg ("Tap to accept call", "Video call from " + data.server.message.caller, {"action": "invitation", "caller": data.server.message.caller, "room": data.server.message.room}, 'TYPE_RINGTONE');
                $("#messages").append("<button onclick='javascript: mobileAnswer(" + '"' + data.server.message.caller + '"' + ', "' + data.server.message.callee + '"' + ', ' + '"' + data.server.message.room + '"' + ");'>Answer</button>");
              }
              
              // Desktop browser
              else {
                // foreground message
                $("#messages").append("<button onclick='javascript: desktopAnswer(" + '"' + data.server.message.caller + '"' + ', "' + data.server.message.callee + '"' + ', ' + '"' + data.server.message.room + '"' + ");'>Answer</button>");
              }
              
            break;
            
            case "hangup":
              
              // mobile device
              if (dready)  {
                // background notification
                msg ("Tap to view missed call.", data.server.message.caller + " hung up video call.", {"action": "hangup", "caller": data.server.message.caller,  "room": data.server.message.room});
              }
              
              // Desktop browser
              else {
                // foreground message
                $("#messages").html('');
                $("#messages").append("<h2>" + data.server.message.caller + ' hung up video call.</h2>');
              }
            break;
            
            case "userlist":
              updateList (data.server.message);
            break;
            
          }
          
        });
        
        function answer (caller, callee, room) {
          socket.emit('answer', {
            "callee": {
              "caller": caller,
              "callee": callee,
              "room": alias + callee
            }
          });
        }
        
        function call (callee, room) {
    
          $("#messages").html('');
          $("#messages").append("<h2>Calling " + callee + '</h2>');
          $("#messages").append("<button onclick='javascript: hangup(" + '"' + callee + '"' + ");'>Hang up!</a>");
          
          socket.emit('call', {
            "caller": {
              "caller": alias,
              "callee": callee,
              "room": room || alias + callee
            }
          });
        }
        
        function desktopAnswer (caller, callee, room) {
          
          $("#messages").html('');
          answer (caller, callee,room);
          window.open ("http://it4se.com:8080/kdmon/phonegaptest/master/webrtc.html?room=" + room);
        }
        
        function mobileAnswer (caller, callee, room) {
          $("#messages").html('');
          answer (caller, callee, room);
          navigator.app.loadUrl("http://it4se.com:8080/kdmon/phonegaptest/master/webrtc.html?room=" + room, {openExternal : true});
        }
        
        function hangup (callee) {
          
          socket.emit('hangup', {
            "caller": {
              "caller": alias,
              "callee": callee
            }
          });
        }
        
        function init() {
          
          if (dready) return;
          dready = true;
          
  
            window.plugin.notification.local.onclick = function(id, state, json) {
              var obj = JSON.parse(json);
              //alert(id + state + json);
              //var ref = window.open('http://it4se.com/upload/webrtc.html', '_system', 'location=no');
              switch (obj.action) {
                case "hangup":
                break;
                
                case "invitation":
                  answer (obj.caller, obj.callee, obj.room);
                  navigator.app.loadUrl("http://it4se.com:8080/kdmon/phonegaptest/master/webrtc.html?room=" + obj.room, {openExternal : true});
                break;
              }
            };
          
      
          /*
          // window.plugin.backgroundMode.enable();
          
          setInterval(function() {
          
          
            $.get("http://en.wikipedia.org/w/api.php?action=query&list=pageswithprop&format=json&pwppropname=title&pwpprop=title&pwplimit=1&generator=random&grnnamespace=0&grnlimit=1", function (obj){
                
                var title = '';
                $.each(obj.query.pages, function (k,v) {title = obj.query.pages[k].title});
                var jobj = {room: 'z3zsv4bZsO0'};
                
                msg ("Random Wikipedia article", title, jobj);
            });
          
          },  30000);
          
          */
        
        }
        
        function msg(t, m, j, s) {
          c++;
          window.plugin.notification.local.add({
              id: c,
              title: t || 'No title',
              message: m || 'No message',
              json: j || '{}',
              sound: s || 'TYPE_NOTIFICATION'
            });
        }
        
        function updateList (users) {
          $("#userlist").html('');
          for (var key in users) {
            $("#userlist").append('<li>' + users[key].alias + ' (' + users[key].state + ") <button onclick='javascript: call (" + '"' + key + '"' + ");'>Call</button></li>");
          }
        }
        
        function register () {
          alias = $("#alias").val();
          localStorage['alias'] = alias;
          socket.emit('register', {
            "caller": {
              "alias": alias,
              "state": 'idle'
            }
          });
        }
        
        // event listeners
        
        // on document ready
        $(function() {
          alias = localStorage['alias'] || "Guest_" + Math.round(Math.random()*100000);
          $("#alias").val(alias);
          // auto-register
          register();
        });
        
        document.addEventListener("deviceready", init, false);
      
    </script>
   
  </head>

  <body>
    <h1>Pick an alias:</h1>
    <input id="alias" type="text">
    <button onclick="javascript: register();">Change name</button>
    <div id="messages"></div>
    <h1>Registered users:</h1>
    <ol id="userlist"></ol>
    
  </body>

</html>