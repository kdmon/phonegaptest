<html>

  <head>
    <script type="text/javascript" src="phonegap.js"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://it4se.com:9000/socket.io/socket.io.js"></script>
    <script>
      
      var socket = io.connect('http://it4se.com:9000');
      var alias = "A test user";
      
      function call(callee, room) {
        socket.emit('call', {
          "caller": {
            "caller": alias,
            "callee": callee,
            "room": room
          }
        });
      }
      
      function updateList (users) {
        $("#userlist").html('');
        for (var key in users) {
          $("#userlist").append('<li>' + users[key].alias + ' (' + users[key].state + ') <button onclick="javascript: call(' + key + ')">Call</button></li>');
        }
      }
      
      function register(alias, state) {
        socket.emit('register', {
          "caller": {
            "alias": alias,
            "state": state
          }
        });
      }
      
      
      socket.on('serverUpdate', function (data) {
        
        switch (data.action) {
          case "invite":
            msg ("Tap to accept call", "Video call from " + data.message.caller, {"room": data.message.room});
          break;
          
          case "userlist":
            updateList (data.message);
          break;
          
        }
        
      });
      
      var dready = false;
      
      document.addEventListener("deviceready", init, false);

      function init() {
        
        msg ("Dev init", "Device ready", {room: 'z3zsv4bZsO0'});
        
        if (dready) return;
        dready = true;
        
        // window.plugin.backgroundMode.enable();
        
        setInterval(function() {
        
        
          $.get("http://en.wikipedia.org/w/api.php?action=query&list=pageswithprop&format=json&pwppropname=title&pwpprop=title&pwplimit=1&generator=random&grnnamespace=0&grnlimit=1", function (obj){
              
              var title = '';
              $.each(obj.query.pages, function (k,v) {title = obj.query.pages[k].title});
              var jobj = {room: 'z3zsv4bZsO0'};
              
              msg ("Random Wikipedia article", title, jobj);
          });
        
          window.plugin.notification.local.onclick = function(id, state, json) {
            alert(id + state + json);
            //var ref = window.open('http://it4se.com/upload/webrtc.html', '_system', 'location=no');
            var obj = JSON.parse(json);
            navigator.app.loadUrl("http://it4se.com:8080/kdmon/phonegaptest/master/webrtc.html?room=" + obj.room, {openExternal : true});
          };
      
        },  30000);
      
      }
      
      var c = 100;

      function msg(t, m, j, s) {
        c++;
        window.plugin.notification.local.add({
            id: c,
            title: t || 'No title',
            message: m || 'No message',
            json: j || '{}',
            sound: s || 'TYPE_NOTIFICATION'
          });
      }
    </script>
  </head>

  <body>
    <h1>Registered users:</h1>
    <ol id="userlist"></ol>
    <hr/>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('Not', 'Notification msg', '', 'TYPE_NOTIFICATION');">Notification!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('Ala', 'Alarm msg', '', 'TYPE_ALARM');">Alarm!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('Rng', 'Ringtone msg', '', 'TYPE_RINGTONE');">Ringtone!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('mp3a', 'mp3 msg', '', 'res/gaudio.mp3');">mp3-a!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('mp3b', 'mp3 msg', '', 'res/www/gaudio.mp3');">mp3-b!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('mp3c', 'mp3 msg', '', 'res/android/www/gaudio.mp3');">mp3-c!</button>
    <hr>
       <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('mp3a', 'mp3 msg', '', '/res/gaudio.mp3');">mp3-a!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('mp3b', 'mp3 msg', '', '/res/www/gaudio.mp3');">mp3-b!</button>
    <button style="font-size: 2em; padding: 10px; background: #cfc;" onclick="javascript: msg('mp3c', 'mp3 msg', '', '/android_asset/www/gaudio.mp3');">mp3-c!</button>
    
  </body>

</html>